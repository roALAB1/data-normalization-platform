version: '3.8'

services:
  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: pgbouncer-normalization
    environment:
      # Database connection (will be passed from .env)
      - DATABASE_URL=${DATABASE_URL}
      
      # Connection pooling mode
      # - session: one connection per client session (safest, but less efficient)
      # - transaction: one connection per transaction (recommended for most apps)
      # - statement: one connection per statement (most aggressive, use with caution)
      - POOL_MODE=transaction
      
      # Maximum number of client connections allowed
      - MAX_CLIENT_CONN=1000
      
      # Default pool size per database/user pair
      # This is the number of persistent connections to the database
      - DEFAULT_POOL_SIZE=20
      
      # Minimum pool size (keep connections warm)
      # Ensures this many connections are always open
      - MIN_POOL_SIZE=5
      
      # Reserve pool for urgent connections
      # Additional connections available when default pool is exhausted
      - RESERVE_POOL_SIZE=5
      
      # Maximum connections per database
      - MAX_DB_CONNECTIONS=25
      
      # Maximum connections per user
      - MAX_USER_CONNECTIONS=25
      
      # Server connection settings
      - SERVER_IDLE_TIMEOUT=600
      - SERVER_LIFETIME=3600
      - SERVER_CONNECT_TIMEOUT=15
      
      # Query timeouts (0 = disabled)
      - QUERY_TIMEOUT=0
      - QUERY_WAIT_TIMEOUT=120
      
      # Logging
      - LOG_CONNECTIONS=1
      - LOG_DISCONNECTIONS=1
      - LOG_POOLER_ERRORS=1
    
    ports:
      # Expose PgBouncer on port 6432
      # Your app should connect to localhost:6432 instead of the database directly
      - "6432:5432"
    
    restart: unless-stopped
    
    # Health check to ensure PgBouncer is running
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    networks:
      - normalization-network

networks:
  normalization-network:
    driver: bridge
