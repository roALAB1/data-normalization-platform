# PgBouncer Configuration Example
# Copy this file to .env and update with your actual values

# ============================================================================
# DATABASE CONNECTION
# ============================================================================

# BEFORE PgBouncer (Direct database connection):
# DATABASE_URL=mysql://username:password@database-host:3306/database_name

# AFTER PgBouncer (Connection through PgBouncer):
# Change the host to localhost and port to 6432
DATABASE_URL=mysql://username:password@localhost:6432/database_name

# ============================================================================
# PGBOUNCER SETTINGS
# ============================================================================

# PgBouncer host (usually localhost when running in Docker)
PGBOUNCER_HOST=localhost

# PgBouncer port (default: 6432)
PGBOUNCER_PORT=6432

# PgBouncer admin credentials (for monitoring)
# These are used to query PgBouncer statistics
PGBOUNCER_ADMIN_USER=pgbouncer
PGBOUNCER_ADMIN_PASSWORD=

# ============================================================================
# CONNECTION POOL SETTINGS
# ============================================================================

# Pool mode: transaction (recommended), session, or statement
POOL_MODE=transaction

# Maximum number of client connections allowed
MAX_CLIENT_CONN=1000

# Default pool size per database/user pair
# This is the number of persistent connections to the database
DEFAULT_POOL_SIZE=20

# Minimum pool size (keep connections warm)
MIN_POOL_SIZE=5

# Reserve pool for urgent connections
RESERVE_POOL_SIZE=5

# Maximum connections per database
MAX_DB_CONNECTIONS=25

# Maximum connections per user
MAX_USER_CONNECTIONS=25

# ============================================================================
# PERFORMANCE TUNING
# ============================================================================

# Server idle timeout (seconds)
# How long a server connection can be idle before being closed
SERVER_IDLE_TIMEOUT=600

# Server lifetime (seconds)
# Maximum lifetime of a server connection
SERVER_LIFETIME=3600

# Server connect timeout (seconds)
# How long to wait when connecting to the database
SERVER_CONNECT_TIMEOUT=15

# Query timeout (seconds, 0 = disabled)
# Maximum time allowed for a query to execute
QUERY_TIMEOUT=0

# Query wait timeout (seconds)
# How long a client can wait for a connection
QUERY_WAIT_TIMEOUT=120

# ============================================================================
# MONITORING & LOGGING
# ============================================================================

# Enable connection logging (1 = enabled, 0 = disabled)
LOG_CONNECTIONS=1

# Enable disconnection logging
LOG_DISCONNECTIONS=1

# Enable pooler error logging
LOG_POOLER_ERRORS=1

# ============================================================================
# USAGE INSTRUCTIONS
# ============================================================================

# 1. Copy this file to .env:
#    cp .env.pgbouncer.example .env

# 2. Update DATABASE_URL to use localhost:6432

# 3. Start PgBouncer:
#    docker-compose -f docker-compose.pgbouncer.yml up -d

# 4. Verify PgBouncer is running:
#    docker ps | grep pgbouncer

# 5. Check PgBouncer logs:
#    docker logs pgbouncer-normalization

# 6. Monitor connection pool:
#    curl http://localhost:3000/api/trpc/monitoring.connectionPoolStats

# 7. View Prometheus metrics:
#    curl http://localhost:3000/metrics

# ============================================================================
# TROUBLESHOOTING
# ============================================================================

# If connections fail:
# - Check PgBouncer is running: docker ps
# - Check DATABASE_URL uses port 6432
# - Check firewall allows port 6432
# - Check PgBouncer logs: docker logs pgbouncer-normalization

# If pool is exhausted (waiting clients):
# - Increase DEFAULT_POOL_SIZE
# - Increase MAX_DB_CONNECTIONS
# - Check for connection leaks in application code

# If queries are slow:
# - Check pool utilization metrics
# - Verify connections are being reused
# - Consider increasing MIN_POOL_SIZE to keep connections warm

# ============================================================================
# PERFORMANCE BENCHMARKS
# ============================================================================

# Expected improvements with PgBouncer:
# - Connection time: 50-100ms → <5ms (10-20x faster)
# - Max concurrent users: 100 → 1,000+ (10x capacity)
# - Query latency: -30% to -50% (connection overhead eliminated)
# - Database connections: 1 per request → 20 persistent (resource efficient)
